<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏°‡πÄ‡∏õ‡πà‡∏≤ ‡∏¢‡∏¥‡∏á ‡∏â‡∏∏‡∏ö</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        video { border: 2px solid black; }
        #countdown { font-size: 30px; font-weight: bold; color: red; margin-top: 10px; }
        #result-box { font-size: 24px; font-weight: bold; margin-top: 20px; color: green; }
        #player-choice, #computer-choice { font-size: 20px; margin: 10px; }
        #restart-button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; background: #ff6666; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>‡πÄ‡∏Å‡∏°‡πÄ‡∏õ‡πà‡∏≤ ‡∏¢‡∏¥‡∏á ‡∏â‡∏∏‡∏ö</h1>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <p id="countdown">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°...</p>
    <p id="player-choice">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏°‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
    <p id="computer-choice">‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -</p>
    <p id="result-box"></p>
    <button id="restart-button" onclick="restartGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>

    <script>
        let choices = ["‚úä", "‚úã", "‚úåÔ∏è"];
        let lastDetected = null;
        let confirmFrames = 0;
        let detectedHand = false;
        let gameStarted = false;
        let countdownTimer = 3;

        async function runHandTracking() {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");

            navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
                video.srcObject = stream;
            });

            const model = await handpose.load();
            startCountdown();

            async function detect() {
                const predictions = await model.estimateHands(video);

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                detectedHand = predictions.length > 0;

                if (detectedHand && countdownTimer <= 0) {
                    const landmarks = predictions[0].landmarks;
                    drawHand(ctx, landmarks);
                    let choice = detectHandGesture(landmarks);

                    if (choice !== null) {
                        if (choice === lastDetected) {
                            confirmFrames++;
                        } else {
                            confirmFrames = 0;
                        }
                        lastDetected = choice;

                        if (confirmFrames > 15 && !gameStarted) { 
                            gameStarted = true;
                            playGame(choice);
                        }
                    }
                }

                requestAnimationFrame(detect);
            }

            detect();
        }

        function drawHand(ctx, landmarks) {
            ctx.strokeStyle = "red";
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let i = 0; i < landmarks.length; i++) {
                const [x, y] = landmarks[i];
                ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function detectHandGesture(landmarks) {
            let fingers = [
                landmarks[8][1] < landmarks[6][1],  
                landmarks[12][1] < landmarks[10][1], 
                landmarks[16][1] < landmarks[14][1], 
                landmarks[20][1] < landmarks[18][1]
            ];
            let thumb = landmarks[4][1] < landmarks[3][1];

            let count = fingers.filter(Boolean).length + (thumb ? 1 : 0);

            if (count === 0) return "‚úä"; 
            if (count === 5) return "‚úã"; 
            if (count === 2) return "‚úåÔ∏è"; 

            return null;
        }

        function playGame(playerChoice) {
            let computerChoice = choices[Math.floor(Math.random() * choices.length)];
            document.getElementById("player-choice").innerText = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${playerChoice}`;
            document.getElementById("computer-choice").innerText = `‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${computerChoice}`;
            
            let result = determineWinner(playerChoice, computerChoice);
            document.getElementById("result-box").innerText = result;

            sendGameResult(playerChoice, computerChoice, result);
        }

        function determineWinner(player, computer) {
            if (player === computer) return "‡πÄ‡∏™‡∏°‡∏≠!";
            if (
                (player === "‚úä" && computer === "‚úåÔ∏è") || 
                (player === "‚úã" && computer === "‚úä") || 
                (player === "‚úåÔ∏è" && computer === "‚úã")
            ) {
                return "‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞! üéâ";
            } else {
                return "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ! üò¢";
            }
        }

        function sendGameResult(playerChoice, computerChoice, result) {
            google.script.run.withSuccessHandler((response) => {
                console.log(response);
            }).saveGameResult(playerChoice, computerChoice, result);
        }

        function startCountdown() {
            let countdownElement = document.getElementById("countdown");
            countdownElement.innerText = `‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°...`;

            let interval = setInterval(() => {
                if (countdownTimer > 0) {
                    countdownElement.innerText = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô ${countdownTimer} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
                    countdownTimer--;
                } else {
                    clearInterval(interval);
                    countdownElement.innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡∏°‡∏∑‡∏≠!";
                }
            }, 1000);
        }

        function restartGame() {
            gameStarted = false;
            countdownTimer = 3;
            lastDetected = null;
            confirmFrames = 0;
            document.getElementById("countdown").innerText = "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°...";
            document.getElementById("player-choice").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏°‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...";
            document.getElementById("computer-choice").innerText = "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: -";
            document.getElementById("result-box").innerText = "";
            startCountdown();
        }

        runHandTracking();
    </script>
</body>
</html>
